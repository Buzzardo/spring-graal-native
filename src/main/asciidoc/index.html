<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Andy Clement, SÃ©bastien Deleuze, Filip Hanik, Dave Syer, Esteban Ginez, Jay Bryant">
<title>Spring Graal Native Reference Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Spring Graal Native Reference Guide</h1>
<div class="details">
<span id="author" class="author">Andy Clement</span><br>
<span id="author2" class="author">SÃ©bastien Deleuze</span><br>
<span id="author3" class="author">Filip Hanik</span><br>
<span id="author4" class="author">Dave Syer</span><br>
<span id="author5" class="author">Esteban Ginez</span><br>
<span id="author6" class="author">Jay Bryant</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_what_about_spring">1. What about Spring?</a></li>
<li><a href="#_contact_us">2. Contact us!</a></li>
<li><a href="#agent">3. Using the GraalVM agent</a>
<ul class="sectlevel2">
<li><a href="#_download_and_install_graalvm">3.1. Download and install GraalVM</a></li>
<li><a href="#_setup_the_sample_project">3.2. Setup the sample project</a>
<ul class="sectlevel3">
<li><a href="#_update_the_pom_xml">3.2.1. Update the pom.xml</a></li>
<li><a href="#_add_the_maven_plugin">3.2.2. add the maven plugin</a></li>
<li><a href="#_add_the_repository_for_spring_graal_native">3.2.3. Add the repository for spring-graal-native</a></li>
<li><a href="#_add_the_feature_and_appropriate_configuration_dependencies">3.2.4. Add the feature and appropriate configuration dependencies</a></li>
<li><a href="#_set_the_start_class">3.2.5. Set the start-class</a></li>
<li><a href="#_update_the_source_code">3.2.6. Update the source code</a>
<ul class="sectlevel4">
<li><a href="#_proxies">Proxies</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_create_a_location_for_the_generated_configuration">3.3. Create a location for the generated configuration</a></li>
<li><a href="#_run_the_app_with_the_agent">3.4. Run the app with the agent</a></li>
<li><a href="#_what_about_initialization_configuration">3.5. What about initialization configuration?</a></li>
<li><a href="#_build_the_app">3.6. Build the app!</a>
<ul class="sectlevel3">
<li><a href="#_run_it">3.6.1. Run it</a></li>
</ul>
</li>
<li><a href="#_phew">3.7. Phew</a></li>
</ul>
</li>
<li><a href="#extension_guide">4. Extension Guide</a>
<ul class="sectlevel2">
<li><a href="#_extending_the_feature">4.1. Extending the feature</a></li>
<li><a href="#_hints">4.2. Hints</a></li>
<li><a href="#_triggered">4.3. Triggered</a></li>
<li><a href="#_what_do_hints_look_like">4.4. What do hints look like?</a></li>
<li><a href="#_optimizing_which_hints_are_acted_on">4.5. Optimizing which hints are acted on</a></li>
<li><a href="#_structure_of_the_spring_boot_graal_configuration_module">4.6. Structure of the spring-boot-graal-configuration module</a></li>
<li><a href="#_contributing_new_hints">4.7. Contributing new hints</a></li>
<li><a href="#_is_this_the_way">4.8. Is this the way?</a></li>
</ul>
</li>
<li><a href="#feature">5. Feature</a>
<ul class="sectlevel2">
<li><a href="#_download_and_install_graalvm_2">5.1. Download and install GraalVM</a></li>
<li><a href="#_setup_the_sample_project_2">5.2. Setup the sample project</a>
<ul class="sectlevel3">
<li><a href="#_update_the_pom_xml_2">5.2.1. Update the pom.xml</a></li>
<li><a href="#_add_the_maven_plugin_2">5.2.2. add the maven plugin</a></li>
<li><a href="#_add_the_repository_for_spring_graal_native_2">5.2.3. Add the repository for spring-graal-native</a></li>
<li><a href="#_add_the_appropriate_dependencies">5.2.4. Add the appropriate dependencies</a></li>
<li><a href="#_set_the_start_class_2">5.2.5. Set the start-class</a></li>
<li><a href="#_update_the_source_code_2">5.2.6. Update the source code</a>
<ul class="sectlevel4">
<li><a href="#_proxies_2">Proxies</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_build_the_app_2">5.3. Build the app!</a></li>
<li><a href="#_run_it_2">5.4. Run it</a></li>
<li><a href="#_phew_2">5.5. Phew</a></li>
</ul>
</li>
<li><a href="#hybrid">6. Hybrid Feature-Agent</a>
<ul class="sectlevel2">
<li><a href="#_download_and_install_graalvm_3">6.1. Download and install GraalVM</a></li>
<li><a href="#_setup_the_sample_project_3">6.2. Setup the sample project</a></li>
<li><a href="#_update_the_pom_xml_3">6.3. Update the pom.xml</a>
<ul class="sectlevel3">
<li><a href="#_add_the_maven_plugin_3">6.3.1. add the maven plugin</a></li>
<li><a href="#_add_the_feature_and_appropriate_configuration_dependencies_2">6.3.2. add the feature and appropriate configuration dependencies</a></li>
<li><a href="#_set_the_start_class_3">6.3.3. Set the start-class</a></li>
<li><a href="#_update_the_source_code_3">6.3.4. Update the source code</a>
<ul class="sectlevel4">
<li><a href="#_proxies_3">Proxies</a></li>
</ul>
</li>
<li><a href="#_create_a_location_for_the_generated_configuration_2">6.3.5. Create a location for the generated configuration</a></li>
<li><a href="#_run_the_app_with_the_agent_2">6.3.6. Run the app with the agent</a></li>
<li><a href="#_run_it_3">6.3.7. Run it</a></li>
<li><a href="#_phew_3">6.3.8. Phew</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#options">7. Options</a>
<ul class="sectlevel2">
<li><a href="#_graalvm_options">7.1. GraalVM options</a>
<ul class="sectlevel3">
<li><a href="#_options_enabled_by_default">7.1.1. Options enabled by default</a></li>
<li><a href="#_options_recommended_by_default">7.1.2. Options recommended by default</a></li>
<li><a href="#_other_options">7.1.3. Other options</a></li>
</ul>
</li>
<li><a href="#_feature_options">7.2. Feature options</a></li>
</ul>
</li>
<li><a href="#samples">8. Samples</a></li>
<li><a href="#troubleshooting">9. Troubleshooting</a>
<ul class="sectlevel2">
<li><a href="#_native_image_is_failing">9.1. <code>native-image</code> is failing</a>
<ul class="sectlevel3">
<li><a href="#_out_of_memory_when_building_the_native_image">9.1.1. out of memory when building the native image</a></li>
<li><a href="#_weird_crash">9.1.2. Weird crash</a></li>
</ul>
</li>
<li><a href="#_the_built_image_will_not_run">9.2. the built image will not run</a>
<ul class="sectlevel3">
<li><a href="#_missing_resource_bundles">9.2.1. missing resource bundles</a></li>
<li><a href="#_classnotfoundexception">9.2.2. ClassNotFoundException</a></li>
</ul>
</li>
<li><a href="#_where_has_my_logging_gone">9.3. Where has my logging gone?</a>
<ul class="sectlevel3">
<li><a href="#_no_access_hint_found_for_import_selector_xxx">9.3.1. No access hint found for import selector: XXX</a></li>
</ul>
</li>
<li><a href="#_diagnosing_issues_with_the_feature">9.4. Diagnosing issues with the feature</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div id="introduction" class="paragraph">
<p>This guide walks you through the various options for building GraalVM native-images for your Spring Boot applications.</p>
</div>
<div class="paragraph">
<p>This involves compiling your application as normal and then running an extra native-image step that builds a self contained platform specific executable for that application.
The executable should have a more predictable memory profile as well as fast startup.</p>
</div>
<div class="paragraph">
<p>The key complexity in building a native image is that the image building process needs to be informed about what your application is going to do at runtime.
The build process attempts to construct the most optimal image possible and therefore tries to exclude anything not strictly required.
However, it needs a few hints here and there sometimes so it can ensure it includes all necessary code/data in the image to satisfy the application runtime needs.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the application is going to reflect at runtime on some type/field/method/constructor, the native image must include the data to satisfy those reflection requests.</p>
</li>
<li>
<p>If the application is going to load resources (like application.properties) they must be included in the image.</p>
</li>
<li>
<p>If the application is going to try to use proxies at runtime, these must be generated up front during the image build process and included in the image.</p>
</li>
<li>
<p>There can be a benefit to initializing classes when the image is built as opposed to when the resultant executable starts up.
The image build process needs to be told which classes to initialize at build time vs at run time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are two primary ways to communicate this information to the build process.
Either via JSON files on the classpath, or via a feature (a GraalVM feature) that participates in the image build process and after analyzing the application being compiled, calls APIs to register information about reflection/resources/proxies/etc.</p>
</div>
<div class="paragraph">
<p>Some projects are starting to include the necessary JSON files in their default distributions (e.g. netty).</p>
</div>
<div class="paragraph">
<p>Crafting these JSON files can be tricky, but they can actually be computed by using an agent that comes with GraalVM.
Run the application and exercise all relevant code paths (maybe via tests) with the agent attached and it will produce most of the configuration.
The only part it will not compute is the initialization hints.</p>
</div>
<div class="paragraph">
<p>It is worth mentioning that there are limitations on what GraalVM supports with respect to native images.
If your application is doing any of these it may not be possible to build a native image.
The limitations are discussed <a href="https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md">here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_about_spring">1. What about Spring?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The spring-graal-native project represents a work-in-progress attempt at implementing a GraalVM feature.
This feature will examine the Spring Boot application being built and tell the image build process about it.
The feature understands how Spring is implemented and so from examining what auto configuration is defined on the classpath, which components are defined, etc., it knows what to grant reflective access to and what to generate proxies for.</p>
</div>
<div class="paragraph">
<p>The feature is a work in progress: there are numerous sample projects for which it works, as can be seen in the samples folder within the project (<a href="#samples">read more about the samples here</a>), but does that mean it will work on the first thing you try it on?
That is not guaranteed.
When things don&#8217;t work (notice that doesn&#8217;t say if) don&#8217;t panic, there are multiple ways to proceed, and this wiki will cover those.</p>
</div>
<div class="paragraph">
<p>See the <a href="#feature">feature guide</a> for more information on getting started with the Spring feature, including a full walkthrough with example.</p>
</div>
<div class="paragraph">
<p>It is also possible just to use the GraalVM supplied agent to determine the configuration data for your Spring application, see <a href="#agent">the agent guide</a> for that approach.
Be aware that there are still bugs in the agent though, and it can 'miss things' - resolving these misses can be tricky.
We are working with the GraalVM team to ensure issues are fixed up.</p>
</div>
<div class="paragraph">
<p>There is even a hybrid model where the feature and the agent are used together.
Neither the feature nor the agent are perfect, but sometimes they can nicely complement each others deficiencies! See <a href="#hybrid">the hybrid guide</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_contact_us">2. Contact us!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Finally, just before you post that rant about it not working, please check the <a href="#troubleshooting">troubleshooting guide</a> which is full of information on pitfalls, common problems, and how to deal with them (via fixes/workarounds).</p>
</div>
<div class="paragraph">
<p>We would love to hear about successes/failures you are having through the project issue tracker.
Work has been started on an extension model that makes it easy to support areas of Spring the feature doesn&#8217;t yet reach.
If you are thinking about making a contribution here, see the <a href="#extension_guide">extension guide</a>.
Please just be aware this is pre-1.0 and as such some of these options/extension APIs are still evolving and may change before it is finally considered done.</p>
</div>
<div class="paragraph">
<p>Good luck!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="agent">3. Using the GraalVM agent</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The GraalVM agent can be attached to an application and during the course of the applications execution it will produce the necessary configuration files for a subsequent native-image build.
As the application runs it will observe the types being reflectively accessed, the resources being loaded, the proxies being requested, and it will capture this information in .json files.</p>
</div>
<div class="paragraph">
<p>This section will walkthrough using the agent to compute the configuration data and then building a native-image using it.
A real application will be used to show the process but the same techniques should apply to any application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently there are agent bugs and we&#8217;ll cover those as we go, how they manifest and how to do deal with them
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_download_and_install_graalvm">3.1. Download and install GraalVM</h3>
<div class="paragraph">
<p>Although the native-image build is going to be invoked via maven, the agent is shipped with GraalVM and we need to install it by following <a href="https://github.com/spring-projects-experimental/spring-graal-native#install-graalvm-native">these instructions</a>.
Notice there are Java8 and Java11 versions available.
Although either should work we have had more issues with the Java11 one, so playing it safe would be selecting the Java8 version.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setup_the_sample_project">3.2. Setup the sample project</h3>
<div class="paragraph">
<p>Like the instructions for using the feature, here we will use the getting started rest service guide.
This is the sample project we will be tracing with the agent and then building into a native-image.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">git clone https://github.com/spring-guides/gs-rest-service
cd gs-rest-service/complete</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_update_the_pom_xml">3.2.1. Update the pom.xml</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Ensure the project is using a supported version of Spring Boot
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Upgrade the project to Spring Boot 2.3.0.M3.</p>
</div>
<div class="paragraph">
<p>If using a milestone (or snapshot) of boot, these repositories will need adding to the pom.xml too:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;pluginRepositories&gt;
    &lt;!-- ... --&gt;
    &lt;pluginRepository&gt;
        &lt;id&gt;spring-milestone&lt;/id&gt;
        &lt;name&gt;Spring Milestone&lt;/name&gt;
        &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;
    &lt;/pluginRepository&gt;
&lt;/pluginRepositories&gt;
&lt;repositories&gt;
    &lt;!-- ... --&gt;
    &lt;repository&gt;
        &lt;id&gt;spring-milestone&lt;/id&gt;
        &lt;name&gt;Spring Milestone&lt;/name&gt;
        &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;
    &lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_add_the_maven_plugin">3.2.2. add the maven plugin</h4>
<div class="paragraph">
<p>GraalVM provides a <a href="https://www.graalvm.org/docs/reference-manual/native-image/#integration-with-maven">maven plugin</a> that we are going to bring in here. Paste this XML into the pom - we will use it later to invoke the native image build.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;profiles&gt;
  &lt;profile&gt;
    &lt;id&gt;graal&lt;/id&gt;
    &lt;build&gt;
      &lt;plugins&gt;
        &lt;plugin&gt;
          &lt;groupId&gt;org.graalvm.nativeimage&lt;/groupId&gt;
          &lt;artifactId&gt;native-image-maven-plugin&lt;/artifactId&gt;
          &lt;version&gt;20.0.0&lt;/version&gt;
          &lt;configuration&gt;
            &lt;buildArgs&gt;-Dspring.graal.mode=initialization-only --no-fallback --allow-incomplete-classpath --report-unsupported-elements-at-runtime -H:+ReportExceptionStackTraces --no-server&lt;/buildArgs&gt;
          &lt;/configuration&gt;
          &lt;executions&gt;
            &lt;execution&gt;
              &lt;goals&gt;
                &lt;goal&gt;native-image&lt;/goal&gt;
              &lt;/goals&gt;
              &lt;phase&gt;package&lt;/phase&gt;
            &lt;/execution&gt;
          &lt;/executions&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
          &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
          &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
        &lt;/plugin&gt;
      &lt;/plugins&gt;
    &lt;/build&gt;
  &lt;/profile&gt;
&lt;/profiles&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The important part is perhaps the <code>&lt;buildArgs&gt;..&lt;/buildArgs&gt;</code> block showing the options we are passing to the native-image operation and the spring-graal-native feature.
Those prefixed <code>-D</code> are aimed at the feature.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
see the --no-server option.
Like a gradle daemon the server here is supposed to help accelerate subsequent builds. Unfortunately there is an <a href="https://github.com/oracle/graal/issues/1952">issue</a> where the server causes different results to come out of the compilation, hence it is turned off here - in particular we have seen logging disappearing if using the server to aid compilation
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_add_the_repository_for_spring_graal_native">3.2.3. Add the repository for spring-graal-native</h4>
<div class="paragraph">
<p>If necessary, add the repository for the spring-graal-native dependency.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;repositories&gt;
	&lt;!-- ... --&gt;
	&lt;repository&gt;
		&lt;id&gt;spring-snapshot&lt;/id&gt;
		&lt;name&gt;Spring Snapshots&lt;/name&gt;
		&lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt;
	&lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_add_the_feature_and_appropriate_configuration_dependencies">3.2.4. Add the feature and appropriate configuration dependencies</h4>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework&lt;/groupId&gt;
  &lt;artifactId&gt;spring-context-indexer&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.experimental&lt;/groupId&gt;
    &lt;artifactId&gt;spring-graal-native&lt;/artifactId&gt;
    &lt;version&gt;0.6.0.BUILD-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The spring-context-indexer has been in Spring for a while.
In a native-image all notion of classpath is lost so it is not possible to explore the classpath to find components at runtime.
The indexer actually produces a list of components at Java compile time and captures it in a spring.components file in the built application.
If Spring starts and finds this file, it uses it instead of attempting to explore the classpath.
The indexer can be used for this whether building a native image or just running your application as a standard Java app.</p>
</li>
<li>
<p>Why do we need spring-graal-native?
This will be discussed in more detail below but basically the feature is being used in a lightweight mode here where it is not providing all the configuration, it is only providing the initialization configuration.
That is because the agent does not compute this information.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_set_the_start_class">3.2.5. Set the start-class</h4>
<div class="paragraph">
<p>The native image build needs to know the entry point to your application. It does consult a few places to find it but in our sample we should set it in the properties section of the pom.xml</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;start-class&gt;com.example.restservice.RestServiceApplication&lt;/start-class&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_update_the_source_code">3.2.6. Update the source code</h4>
<div class="paragraph">
<p>In the case of this sample, there are no changes to be made but in some Boot applications it may be necessary to make some tweaks to ensure they aren&#8217;t doing anything that is not supported by GraalVM native images.</p>
</div>
<div class="sect4">
<h5 id="_proxies">Proxies</h5>
<div class="paragraph">
<p>The only kind of proxy allowed with native images is a JDK proxy.
It is not possible to use CGLIB or some other kind of generated proxy.
In Boot 2.2 the option was added to avoid creating these kinds of native-image incompatible proxies for configuration class contents and this happens to suit native-image compilation.
The enhancement in question is discussed <a href="https://github.com/spring-projects/spring-framework/wiki/What&#8217;s-New-in-Spring-Framework-5.x#core-container">here</a> and basically applications need to switch to using proxyBeanMethods=false in their configuration annotations - the framework code has already all moved to this model. Here is an example from the webflux-netty sample:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringBootApplication(proxyBeanMethods = false)
public class DemoApplication {

	public static void main(String[] args) {
		SpringApplication.run(DemoApplication.class, args);
	}

	@RestController
	class Foo {

		@GetMapping("/")
		public String greet() {
			return "hi!";
		}
	}

}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_location_for_the_generated_configuration">3.3. Create a location for the generated configuration</h3>
<div class="paragraph">
<p>This can be anywhere but that location needs to be under a location of META-INF/native-image and on the classpath so that the native image operation will automatically pick it up.
If we want to keep this config around we can generate it straight into the project and perhaps store it in version control:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mkdir -p src/main/resources/META-INF/native-image</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the 'proper' location is perhaps a &lt;groupid&gt;/&lt;artifactid&gt; location below native-image but just keeping it simple here for now
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_run_the_app_with_the_agent">3.4. Run the app with the agent</h3>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn clean package
java -agentlib:native-image-agent=config-output-dir=src/main/resources/META-INF/native-image \
  -jar target/rest-service-0.0.1-SNAPSHOT.jar</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It will run as normal. IMPORTANT Whilst it is up make sure you exercise any codepaths you want to ensure are covered by the native image that will be built. Exercising those paths may cause extra reflection access or resource loading, etc.</p>
</div>
<div class="paragraph">
<p>Shutdown the app.</p>
</div>
<div class="paragraph">
<p>Notice the files that now exist in the folder:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">ls -l src/main/resources/META-INF/native-image
total 256
-rw-r--r--  1 foo  bar      4 18 Mar 18:59 jni-config.json
-rw-r--r--  1 foo  bar   1057 18 Mar 18:59 proxy-config.json
-rw-r--r--  1 foo  bar  98309 18 Mar 18:59 reflect-config.json
-rw-r--r--  1 foo  bar  17830 18 Mar 18:59 resource-config.json</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_about_initialization_configuration">3.5. What about initialization configuration?</h3>
<div class="paragraph">
<p>What the agent doesn&#8217;t compute is which types need build time vs run time initialization.
For this reason the spring-graal-native feature is still going to be used, but only to provide that initialization information.
All the reflection/resource/proxy configuration is going to be what we generated.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The feature is also providing a couple of substitutions - these are kind of 'patches' for classes in the framework or dependant libraries that don&#8217;t properly support native-image.
These should be temporary and the proper solution pushed back into the framework/library concerned.
You might have to develop substitutions of your own if your dependant libraries are slow to fix themselves for GraalVM native-image interop
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_build_the_app">3.6. Build the app!</h3>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn -Pgraal clean package</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Did it build cleanly?
If so the resultant executable will be in the target folder named after the start-class (in this case com.example.restservice.RestServiceApplication).</p>
</div>
<div class="paragraph">
<p>Did it fail? See the <a href="#troubleshooting">Troubleshooting</a> section. As of writing this step works.</p>
</div>
<div class="sect3">
<h4 id="_run_it">3.6.1. Run it</h4>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./target/com.example.restservice.RestServiceApplication</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Nooooo! It failed. This is a realistic situation right now - you have to work a little harder whilst the agent is missing things. Let&#8217;s do that now and troubleshoot this problem.</p>
</div>
<div class="paragraph">
<p>When launching it:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Caused by: java.util.MissingResourceException:
Resource bundle not found javax.servlet.http.LocalStrings.
Register the resource bundle using the option
  -H:IncludeResourceBundles=javax.servlet.http.LocalStrings.</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s tweak <code>pom.xml</code> and add <code>-H:IncludeResourceBundles=javax.servlet.http.LocalStrings</code> to the <code>&lt;buildArgs&gt;</code> section as another option.</p>
</div>
<div class="paragraph">
<p>Recompile, now it fails with:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Caused by: java.util.MissingResourceException:
  Resource bundle not found javax.servlet.LocalStrings.
  Register the resource bundle using the option
    -H:IncludeResourceBundles=javax.servlet.LocalStrings</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add that <code>-H:IncludeResourceBundles=javax.servlet.LocalStrings</code> to <code>pom.xml</code> <code>&lt;buildArgs&gt;</code>, and recompile again.</p>
</div>
<div class="paragraph">
<p>Now it might launch but on curling to the endpoint <code>curl <a href="http://localhost:8080/greeting" class="bare">localhost:8080/greeting</a></code> it will show:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Caused by: java.lang.ClassNotFoundException:
  org.apache.catalina.authenticator.jaspic.AuthConfigFactoryImpl
	at com.oracle.svm.core.hub.ClassForNameSupport.forName(ClassForNameSupport.java:60) ~[na:na]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is what happens when the agent misses a reflective usage.
This particular one is <a href="https://github.com/oracle/graal/issues/2198">issue 2198</a> - it has been fixed but after Graal 20.0. In this situation we can manually add this entry, open up <code>src/main/resources/META-INF/native-image/reflect-config.json</code> and insert this on line 2 (after the <code>[</code> on line 1):</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">{
 "name":"org.apache.catalina.authenticator.jaspic.AuthConfigFactoryImpl",
 "allDeclaredConstructors":true,
 "allDeclaredMethods":true
},</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See the startup time is &lt;100ms, compared ~1500ms when starting the fat jar.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_phew">3.7. Phew</h3>
<div class="paragraph">
<p>Hopefully that has given you a taste of the process of building native images. There is much more coming down the pipeline in Spring to optimize in all areas - smaller images, reduced memory usage, faster native image compilation. We are also working with Graal team in all the pitfall areas shown above - things across the board should only get better. If applying these techniques to your own application and having problems, see the page covering <a href="#troubleshooting">Troubleshooting</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="extension_guide">4. Extension Guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to extend Spring Graal Native.</p>
</div>
<div class="sect2">
<h3 id="_extending_the_feature">4.1. Extending the feature</h3>
<div class="paragraph">
<p>We are experimenting with extension models as you will see if you look in the spring-graal-native-configuration module within the project.
Giant .json files are a little unwieldy and the structure of the Spring Boot autoconfigure module means many types would need to be mentioned in a .json file for that module, even though only a fraction of the autoconfigurations are likely to be active in a single application.</p>
</div>
<div class="paragraph">
<p>What the configuration module is trying to achieve is tie the access to certain types to the Spring configuration that needs them.
Then for any given application, if we know the likely active configurations, we can expose only the types most likely to be needed.</p>
</div>
<div class="paragraph">
<p>This page will walk through the structure of this hint data and should make and finish with how to add more configuration for areas we haven&#8217;t looked at yet.
Perhaps you want to work on one and submit it as a PR.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hints">4.2. Hints</h3>
<div class="paragraph">
<p>So the giant .json file the feature project used to include has been decomposed into lots of <code>@NativeImageHint</code> annotations.
Each of these hints specifies a set of types that need accessibility, what kind of accessibility is needed and optionally a trigger.</p>
</div>
<div class="paragraph">
<p>These <code>@NativeImageHint</code> should be hosted in one of two places.</p>
</div>
<div class="paragraph">
<p>Firstly, in the <code>spring-graal-native-configuration</code> module you will see they are hosted on types that implement the <code>org.springframework.graal.extension.NativeImageConfiguration</code> interface (defined by the feature).
Implementations of this interface should be listed in a <code>src/main/resources/META-INF/services/org.springframework.graal.extension.NativeImageConfiguration</code> file which the feature will load via regular Java service loading.</p>
</div>
<div class="paragraph">
<p>Secondly, they can be put directly onto Spring configuration classes and they will be picked up by the feature.</p>
</div>
<div class="paragraph">
<p>In this way if just experimenting with making your application into a native image you can keep the hint configuration separate to the application code (the first case above), once happy with it or feeling super keen you can keep it directly with your configuration.
The first option above also allows hints to be provided for code you don&#8217;t know or otherwise have access to change or rebuild.</p>
</div>
</div>
<div class="sect2">
<h3 id="_triggered">4.3. Triggered</h3>
<div class="paragraph">
<p>It was mentioned a trigger in a NativeImageHint is optional. If there is a trigger it is a Spring configuration class name. If that configuration is thought to be active in a particular application, the specified types in the hint will be made accessible. If there is no trigger then there are two possibilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the trigger will be inferred if the hint is on a Spring configuration type.
(It will be inferred to be the name of that configuration).</p>
</li>
<li>
<p>If purely being used on a type implementing NativeImageConfiguration it will be assumed that the types specified must always be accessible.
This is useful for some common types that any application, regardless of active configurations, is going to need access to.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_what_do_hints_look_like">4.4. What do hints look like?</h3>
<div class="paragraph">
<p>A hint currently looks like this:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">@NativeImageHint(trigger = JacksonAutoConfiguration.class,
  typeInfos = {
    @TypeInfo(types = { JsonGenerator.class },
    access = AccessBits.CLASS | AccessBits.PUBLIC_METHODS
			 | AccessBits.PUBLIC_CONSTRUCTORS)
  })</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Basically it is that optional trigger and a series of <code>@TypeInfo</code> annotations.
Here the trigger is <code>JacksonAutoConfiguration</code> and the hint as a whole reads <em>if it looks like <code>JacksonAutoConfiguration</code> is active in this application, the type <code>JsonGenerator</code> should be made reflectively accessible and the methods and constructors within it should be visible</em>.
One <code>@TypeInfo</code> can list multiple types if they share a similar access need, or there may be multiple <code>@TypeInfo</code> entries in one hint if different groups of types need different kinds of access.</p>
</div>
</div>
<div class="sect2">
<h3 id="_optimizing_which_hints_are_acted_on">4.5. Optimizing which hints are acted on</h3>
<div class="paragraph">
<p>With the feature operating during native image construction, it is in a closed world system and this means the full classpath is known for this application and cannot be extended later.The feature can therefore perform configuration condition checks like <code>@ConditionalOnClass</code> as the image is built and know whether configuration attached to that condition can be active. If configuration looks like it is active, the relevant hints are enacted. The feature also chases down references between configurations (<code>@Import</code>) and looks for hints on any that get pulled in.</p>
</div>
<div class="paragraph">
<p>This means for any application there will be some 'tree' of configurations active with hints scattered across them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_structure_of_the_spring_boot_graal_configuration_module">4.6. Structure of the spring-boot-graal-configuration module</h3>
<div class="paragraph">
<p>In the <code>spring-boot-graal-configuration</code> there are numerous package names that look like Spring package names - and that is deliberate. Notice the use of direct class references in the hints rather than strings - this type safety is a little more robust.
If we upgrade a Spring version and the configuration module no longer compiles - we know something has changed that needs addressing. We may not have noticed if only using String references.
The reason these package names match Spring package names is visibility.
With this setup the hint can refer to a type with only package visibility in the original code.
What about private classes?
There is a fall back in that <code>@TypeInfo</code> can specify names as strings if it absolutely must:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">@TypeInfo(
  typeNames="com.foo.PrivateBar",
  types= {PublicBar.class}
)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice no access specified here - there is a default access of everything - all methods, fields, constructors will be reflectively accessible and the .class bytes will be loadable as a resource.</p>
</div>
</div>
<div class="sect2">
<h3 id="_contributing_new_hints">4.7. Contributing new hints</h3>
<div class="paragraph">
<p>The typical approach is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Notice an error if your application when you try to build it or run it - either a classnotfound, methodnotfound or something similar.
If you are using a piece of Spring we don&#8217;t have a sample for, this is likely to happen.</p>
</li>
<li>
<p>Try to determine which configuration classes are giving rise to the need for that reflective access to occur.
Usually I do a few search for references to the type that is missing and it guides me to the configuration.</p>
</li>
<li>
<p>If there is already a NativeImageConfiguration implementation for that configuration, augment it with the extra type info.
If there isn&#8217;t then create one and attach a <code>@NativeImageHint</code> to it identifying the triggering configuration and the classes that need to be exposed, set the accessibility in the annotation too (in the <code>@TypeInfo</code>).
It is possible more dependencies may need adding to the configuration project to allow the direct class references, that is OK, just ensure they are provided scope.
Ensure if adding a new NativeImageConfiguration that the <code>META-INF/services/*</code> file is updated to reference your new implementation.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_is_this_the_way">4.8. Is this the way?</h3>
<div class="paragraph">
<p>As we play around with this to determine suitability, there are a number of pros and cons we are thinking through:</p>
</div>
<div class="paragraph">
<p>Pros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the type safety of using direct class references is nice
grouping types and knowing the trigger that causes their need to be accessible makes the system easier to reason about and debug.</p>
</li>
<li>
<p>Looking at one entry in a giant json file you may have no idea why that is needed. With the hint structure you can know exactly which configuration causes it to be needed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Currently only works to the granularity of 'all methods' or 'all constructors' - ideally should allow individual methods/constructors to be specified - but how unpleasant will the annotations get?</p>
</li>
<li>
<p>Cannot specify proxies through this mechanism (or jni config or the other flavours&#8230;&#8203;)</p>
</li>
<li>
<p>Not being able to use direct class references for everything isn&#8217;t ideal.
Looks like split packages which isn&#8217;t nice.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So it is an experiment, I&#8217;m sure we&#8217;ll refactor a few times more before we&#8217;re done.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="feature">5. Feature</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section will walkthrough how to try building a native-image for a Spring Boot project.
This will be a practical guide so we&#8217;ll perform this for real on the <a href="https://spring.io/guides/gs/rest-service/">REST service getting started guide</a>.</p>
</div>
<div class="sect2">
<h3 id="_download_and_install_graalvm_2">5.1. Download and install GraalVM</h3>
<div class="paragraph">
<p>Although the native-image build is going to be invoked via maven, the agent is shipped with GraalVM and we need to install it by following <a href="https://github.com/spring-projects-experimental/spring-graal-native#install-graalvm-native">these instructions</a>.
Notice there are Java8 and Java11 versions available.
Although either should work we have had more issues with the Java11 one, so playing it safe would be selecting the Java8 version.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setup_the_sample_project_2">5.2. Setup the sample project</h3>
<div class="paragraph">
<p>Like the instructions for using the feature, here we will use the getting started rest service guide.
This is the sample project we will be tracing with the agent and then building into a native-image.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">git clone https://github.com/spring-guides/gs-rest-service
cd gs-rest-service/complete</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You may already be ready to go with your own project.</p>
</div>
<div class="sect3">
<h4 id="_update_the_pom_xml_2">5.2.1. Update the pom.xml</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Ensure the project is using a supported version of Spring Boot
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Upgrade the project to Spring Boot 2.3.0.M3.</p>
</div>
<div class="paragraph">
<p>If using a milestone (or snapshot) of boot, these repositories will need adding to the pom.xml too:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;pluginRepositories&gt;
    &lt;!-- ... --&gt;
    &lt;pluginRepository&gt;
        &lt;id&gt;spring-milestone&lt;/id&gt;
        &lt;name&gt;Spring Milestone&lt;/name&gt;
        &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;
    &lt;/pluginRepository&gt;
&lt;/pluginRepositories&gt;
&lt;repositories&gt;
    &lt;!-- ... --&gt;
    &lt;repository&gt;
        &lt;id&gt;spring-milestone&lt;/id&gt;
        &lt;name&gt;Spring Milestone&lt;/name&gt;
        &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;
    &lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_add_the_maven_plugin_2">5.2.2. add the maven plugin</h4>
<div class="paragraph">
<p>GraalVM provides a <a href="https://www.graalvm.org/docs/reference-manual/native-image/#integration-with-maven">maven plugin</a> that we are going to bring in here. Paste this XML into the pom - we will use it later to invoke the native image build.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;profiles&gt;
  &lt;profile&gt;
    &lt;id&gt;graal&lt;/id&gt;
    &lt;build&gt;
      &lt;plugins&gt;
        &lt;plugin&gt;
          &lt;groupId&gt;org.graalvm.nativeimage&lt;/groupId&gt;
          &lt;artifactId&gt;native-image-maven-plugin&lt;/artifactId&gt;
          &lt;version&gt;20.0.0&lt;/version&gt;
          &lt;configuration&gt;
            &lt;buildArgs&gt;-Dspring.graal.mode=initialization-only --no-fallback --allow-incomplete-classpath --report-unsupported-elements-at-runtime -H:+ReportExceptionStackTraces --no-server&lt;/buildArgs&gt;
          &lt;/configuration&gt;
          &lt;executions&gt;
            &lt;execution&gt;
              &lt;goals&gt;
                &lt;goal&gt;native-image&lt;/goal&gt;
              &lt;/goals&gt;
              &lt;phase&gt;package&lt;/phase&gt;
            &lt;/execution&gt;
          &lt;/executions&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
          &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
          &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
        &lt;/plugin&gt;
      &lt;/plugins&gt;
    &lt;/build&gt;
  &lt;/profile&gt;
&lt;/profiles&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The important part is perhaps the <code>&lt;buildArgs&gt;..&lt;/buildArgs&gt;</code> block showing the options we are passing to the native-image operation and the spring-graal-native feature.
Those prefixed <code>-D</code> are aimed at the feature.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
see the --no-server option.
Like a gradle daemon the server here is supposed to help accelerate subsequent builds. Unfortunately there is an <a href="https://github.com/oracle/graal/issues/1952">issue</a> where the server causes different results to come out of the compilation, hence it is turned off here - in particular we have seen logging disappearing if using the server to aid compilation
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>-Dspring.graal.remove-unused-autoconfig=true</code> is an option we can use to evaluate some of the Spring Boot conditions at image build time. For example <code>@ConditionalOnClass</code> - because native-image runs at a point when the full classpath is known, we can know for certain if a class is around. If it is not around then the auto configuration conditional on that class can be discarded and not have an impact on the image startup. More details on options are discussed <a href="#here">[here]</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_add_the_repository_for_spring_graal_native_2">5.2.3. Add the repository for spring-graal-native</h4>
<div class="paragraph">
<p>If necessary, add the repository for the spring-graal-native dependency.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;repositories&gt;
	&lt;!-- ... --&gt;
	&lt;repository&gt;
		&lt;id&gt;spring-snapshot&lt;/id&gt;
		&lt;name&gt;Spring Snapshots&lt;/name&gt;
		&lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt;
	&lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_add_the_appropriate_dependencies">5.2.4. Add the appropriate dependencies</h4>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework&lt;/groupId&gt;
  &lt;artifactId&gt;spring-context-indexer&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.experimental&lt;/groupId&gt;
    &lt;artifactId&gt;spring-graal-native&lt;/artifactId&gt;
    &lt;version&gt;0.6.0.BUILD-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The spring-context-indexer has been in Spring for a while.
In a native-image all notion of classpath is lost so it is not possible to explore the classpath to find components at runtime.
The indexer actually produces a list of components at Java compile time and captures it in a spring.components file in the built application.
If Spring starts and finds this file, it uses it instead of attempting to explore the classpath.
The indexer can be used for this whether building a native image or just running your application as a standard Java app.</p>
</li>
<li>
<p>What is spring-graal-native?
The spring-graal-native behaviour is partially driven by hints for any reflective/resource accesses that are not obvious from what it can see in the Spring application being built into a native image. Such hints are included in spring-graal-native as well.
Capturing what needs to be reflectively accessible or loadable as resources that is not obvious from a basic analysis of the application.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_set_the_start_class_2">5.2.5. Set the start-class</h4>
<div class="paragraph">
<p>The native image build needs to know the entry point to your application. It does consult a few places to find it but in our sample we should set it in the properties section of the pom.xml</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;start-class&gt;com.example.restservice.RestServiceApplication&lt;/start-class&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_update_the_source_code_2">5.2.6. Update the source code</h4>
<div class="paragraph">
<p>In the case of this sample, there are no changes to be made but in some Boot applications it may be necessary to make some tweaks to ensure they aren&#8217;t doing anything that is not supported by GraalVM native images.</p>
</div>
<div class="sect4">
<h5 id="_proxies_2">Proxies</h5>
<div class="paragraph">
<p>The only kind of proxy allowed with native images is a JDK proxy.
It is not possible to use CGLIB or some other kind of generated proxy.
In Boot 2.2 the option was added to avoid creating these kinds of native-image incompatible proxies for configuration class contents and this happens to suit native-image compilation.
The enhancement in question is discussed <a href="https://github.com/spring-projects/spring-framework/wiki/What&#8217;s-New-in-Spring-Framework-5.x#core-container">here</a> and basically applications need to switch to using proxyBeanMethods=false in their configuration annotations - the framework code has already all moved to this model. Here is an example from the webflux-netty sample:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringBootApplication(proxyBeanMethods = false)
public class DemoApplication {

	public static void main(String[] args) {
		SpringApplication.run(DemoApplication.class, args);
	}

	@RestController
	class Foo {

		@GetMapping("/")
		public String greet() {
			return "hi!";
		}
	}

}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_the_app_2">5.3. Build the app!</h3>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn -Pgraal clean package</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Did it build cleanly?
If so the resultant executable will be in the target folder named after the <code>start-class</code> (in this case <code>com.example.restservice.RestServiceApplication</code>).</p>
</div>
<div class="paragraph">
<p>Did it fail? See the <a href="#troubleshooting">Troubleshooting</a> page</p>
</div>
</div>
<div class="sect2">
<h3 id="_run_it_2">5.4. Run it</h3>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./target/com.example.restservice.RestServiceApplication

...
Mar 18, 2020 3:26:16 PM org.springframework.boot.web.embedded.tomcat.TomcatWebServer start
INFO: Tomcat started on port(s): 8080 (http) with context path ''
Mar 18, 2020 3:26:16 PM org.springframework.boot.StartupInfoLogger logStarted
INFO: Started RestServiceApplication in 0.084 seconds (JVM running for 0.087)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See the startup time is &lt;100ms, compared ~1500ms when starting the fat jar.</p>
</div>
<div class="paragraph">
<p>Did your app run successfully? If so, great! If not, please see the <a href="#troubleshooting">Troubleshooting</a> page.</p>
</div>
</div>
<div class="sect2">
<h3 id="_phew_2">5.5. Phew</h3>
<div class="paragraph">
<p>Hopefully that has given you a taste of the process of building native images. There is much more coming down the pipeline in Spring to optimize in all areas - smaller images, reduced memory usage, faster native image compilation. We are also working with Graal team in all the pitfall areas shown above - things across the board should only get better. If applying these techniques to your own application and having problems, see <a href="#troubleshooting">Troubleshooting</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="hybrid">6. Hybrid Feature-Agent</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section shows the spring-graal-native feature and agent being used together.</p>
</div>
<div class="paragraph">
<p>This page will walkthrough how to try building a native-image for a Spring Boot project.
This will be a practical guide so we&#8217;ll perform this for real on the <a href="https://spring.io/guides/gs/rest-service/">REST service getting started guide</a>.
Unlike the <a href="#feature">feature</a> or <a href="#agent">agent</a> guides which show how to use those capabilities standalone, this will use them both in a single project.
With the feature not being about to know everything about your app easily, and the agent missing things and not understanding Spring apps, it can sometimes be useful to use them both together.</p>
</div>
<div class="sect2">
<h3 id="_download_and_install_graalvm_3">6.1. Download and install GraalVM</h3>
<div class="paragraph">
<p>Although the native-image build is going to be invoked via maven, the agent is shipped with GraalVM and we need to install it by following <a href="https://github.com/spring-projects-experimental/spring-graal-native#install-graalvm-native">these instructions</a>.
Notice there are Java8 and Java11 versions available.
Although either should work we have had more issues with the Java11 one, so playing it safe would be selecting the Java8 version.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setup_the_sample_project_3">6.2. Setup the sample project</h3>
<div class="paragraph">
<p>Just to get us ready, let&#8217;s clone the sample project:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">git clone https://github.com/spring-guides/gs-rest-service
cd gs-rest-service/complete</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You may already be ready to go with your own project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_update_the_pom_xml_3">6.3. Update the pom.xml</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Ensure the project is using a supported version of Spring Boot
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Upgrade the project to Spring Boot 2.3.0.M3.</p>
</div>
<div class="paragraph">
<p>If using a milestone (or snapshot) of boot, these repositories will need adding to the <code>pom.xml</code> too:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">&lt;pluginRepositories&gt;
    &lt;!-- ... --&gt;
    &lt;pluginRepository&gt;
        &lt;id&gt;spring-milestone&lt;/id&gt;
        &lt;name&gt;Spring Milestone&lt;/name&gt;
        &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;
    &lt;/pluginRepository&gt;
&lt;/pluginRepositories&gt;
&lt;repositories&gt;
    &lt;!-- ... --&gt;
    &lt;repository&gt;
        &lt;id&gt;spring-milestone&lt;/id&gt;
        &lt;name&gt;Spring Milestone&lt;/name&gt;
        &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;
    &lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_add_the_maven_plugin_3">6.3.1. add the maven plugin</h4>
<div class="paragraph">
<p>GraalVM provides a maven plugin that we are going to bring in here.
Paste this XML into the pom - we will use it later to invoke the native image build.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">&lt;profiles&gt;
  &lt;profile&gt;
    &lt;id&gt;graal&lt;/id&gt;
    &lt;build&gt;
      &lt;plugins&gt;
        &lt;plugin&gt;
          &lt;groupId&gt;org.graalvm.nativeimage&lt;/groupId&gt;
          &lt;artifactId&gt;native-image-maven-plugin&lt;/artifactId&gt;
          &lt;version&gt;20.0.0&lt;/version&gt;
          &lt;configuration&gt;
            &lt;buildArgs&gt;-Dspring.graal.remove-unused-autoconfig=true --no-fallback --allow-incomplete-classpath --report-unsupported-elements-at-runtime -H:+ReportExceptionStackTraces --no-server&lt;/buildArgs&gt;
          &lt;/configuration&gt;
          &lt;executions&gt;
            &lt;execution&gt;
              &lt;goals&gt;
                &lt;goal&gt;native-image&lt;/goal&gt;
              &lt;/goals&gt;
              &lt;phase&gt;package&lt;/phase&gt;
            &lt;/execution&gt;
          &lt;/executions&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
          &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
          &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
        &lt;/plugin&gt;
      &lt;/plugins&gt;
    &lt;/build&gt;
  &lt;/profile&gt;
&lt;/profiles&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The important part is perhaps the <code>&lt;buildArgs&gt;..&lt;/buildArgs&gt;</code> block showing the options we are passing to the native-image operation and the <code>spring-graal-native</code> feature.
Those prefixed <code>-D</code> are aimed at the feature.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
see the <code>--no-server</code> option. Like a gradle daemon the server here is supposed to help accelerate subsequent builds.
Unfortunately there is an <a href="https://github.com/oracle/graal/issues/1952">issue</a> where the server causes different results to come out of the compilation, hence it is turned off here - in particular we have seen logging disappearing if using the server to aid compilation
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>-Dspring.graal.remove-unused-autoconfig=true</code> is an option we can use to evaluate some of the Spring Boot conditions at image build time. For example <code>@ConditionalOnClass</code> - because native-image runs at a point when the full classpath is known, we can know for certain if a class is around. If it is not around then the auto configuration conditional on that class can be discarded and not have an impact on the image startup. More details on options are discussed <a href="#options">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_add_the_feature_and_appropriate_configuration_dependencies_2">6.3.2. add the feature and appropriate configuration dependencies</h4>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.experimental&lt;/groupId&gt;
    &lt;artifactId&gt;spring-graal-native-feature&lt;/artifactId&gt;
    &lt;version&gt;0.6.0.BUILD-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.experimental&lt;/groupId&gt;
    &lt;artifactId&gt;spring-graal-native-configuration&lt;/artifactId&gt;
    &lt;version&gt;0.6.0.BUILD-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;org.springframework&lt;/groupId&gt;
  &lt;artifactId&gt;spring-context-indexer&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>spring-context-indexer</code> has been in Spring for a while.
In a native-image all notion of classpath is lost so it is not possible to explore the classpath to find components at runtime.
The indexer actually produces a list of components at Java compile time and captures it in a <code>spring.components</code> file in the built application.
If Spring starts and finds this file, it uses it instead of attempting to explore the classpath.
The indexer can be used for this whether building a native image or just running your application as a standard Java app.</p>
</li>
<li>
<p>What is <code>spring-graal-native-configuration</code>?
The <code>spring-graal-native-feature</code> behaviour is partially driven by hints for any reflective/resource accesses that are not obvious from what it can see in the Spring application being built into a native image.
The <code>spring-graal-native-configuration</code> is once such source of hints.
Capturing what needs to be reflectively accessible or loadable as resources that is not obvious from a basic analysis of the application.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_set_the_start_class_3">6.3.3. Set the start-class</h4>
<div class="paragraph">
<p>The native image build needs to know the entry point to your application.
It does consult a few places to find it but in our sample we should set it in the properties section of the <code>pom.xml</code></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">&lt;start-class&gt;com.example.restservice.RestServiceApplication&lt;/start-class&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_update_the_source_code_3">6.3.4. Update the source code</h4>
<div class="paragraph">
<p>In the case of this sample, there are no changes to be made but in some Boot applications it may be necessary to make some tweaks to ensure they aren&#8217;t doing anything that is not supported by GraalVM native images.</p>
</div>
<div class="sect4">
<h5 id="_proxies_3">Proxies</h5>
<div class="paragraph">
<p>The only kind of proxy allowed with native images is a JDK proxy.
It is not possible to use CGLIB or some other kind of generated proxy.
In Boot 2.2 the option was added to avoid creating these kinds of native-image incompatible proxies for configuration class contents and this happens to suit native-image compilation.
The enhancement in question is discussed <a href="https://github.com/spring-projects/spring-framework/wiki/What&#8217;s-New-in-Spring-Framework-5.x#core-container">here</a> and basically applications need to switch to using proxyBeanMethods=false in their configuration annotations - the framework code has already all moved to this model.
Here is an example from the webflux-netty sample:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">@SpringBootApplication(proxyBeanMethods = false)
public class DemoApplication {

	public static void main(String[] args) {
		SpringApplication.run(DemoApplication.class, args);
	}

	@RestController
	class Foo {

		@GetMapping("/")
		public String greet() {
			return "hi!";
		}
	}

}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_location_for_the_generated_configuration_2">6.3.5. Create a location for the generated configuration</h4>
<div class="paragraph">
<p>When run with the agent it needs somewhere to store the .json files it computes.
This can be anywhere but that location needs to be under a location of <code>META-INF/native-image</code> and on the classpath so that the native image operation will automatically pick it up.
If we want to keep this config around we can generate it straight into the project and perhaps store it in version control:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mkdir -p src/main/resources/META-INF/native-image</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the 'proper' location is perhaps a &lt;groupid&gt;/&lt;artifactid&gt; location below native-image but just keeping it simple here for now
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_run_the_app_with_the_agent_2">6.3.6. Run the app with the agent</h4>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn clean package
java -agentlib:native-image-agent=config-output-dir=src/main/resources/META-INF/native-image \
  -jar target/rest-service-0.0.1-SNAPSHOT.jar</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It will run as normal.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Whilst it is up make sure you exercise any codepaths you want to ensure are covered by the native image that will be built. Exercising those paths may cause extra reflection access or resource loading, etc.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Shutdown the app.</p>
</div>
<div class="paragraph">
<p>Notice the files that now exist in the folder:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">ls -l src/main/resources/META-INF/native-image
total 256
-rw-r--r--  1 foo  bar      4 18 Mar 18:59 jni-config.json
-rw-r--r--  1 foo  bar   1057 18 Mar 18:59 proxy-config.json
-rw-r--r--  1 foo  bar  98309 18 Mar 18:59 reflect-config.json
-rw-r--r--  1 foo  bar  17830 18 Mar 18:59 resource-config.json</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Build a native image for the app</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn -Pgraal clean package</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This will be using the feature to do some computation, but also the input generated by the agent.</p>
</div>
<div class="paragraph">
<p>Did it build cleanly? If so the resultant executable will be in the target folder named after the <code>start-class</code> (in this case <code>com.example.restservice.RestServiceApplication</code>).</p>
</div>
<div class="paragraph">
<p>Did it fail? See the <a href="#troubleshooting">Troubleshooting</a> page. As of writing this step works.</p>
</div>
</div>
<div class="sect3">
<h4 id="_run_it_3">6.3.7. Run it</h4>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./target/com.example.restservice.RestServiceApplication

...
Mar 18, 2020 3:26:16 PM org.springframework.boot.web.embedded.tomcat.TomcatWebServer start
INFO: Tomcat started on port(s): 8080 (http) with context path ''
Mar 18, 2020 3:26:16 PM org.springframework.boot.StartupInfoLogger logStarted
INFO: Started RestServiceApplication in 0.084 seconds (JVM running for 0.087)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See the startup time is &lt;100ms, compared ~1500ms when starting the fat jar.</p>
</div>
<div class="paragraph">
<p>Did your app run successfully? If so, great! If not, please see the <a href="#troubleshooting">Troubleshooting</a> page.</p>
</div>
</div>
<div class="sect3">
<h4 id="_phew_3">6.3.8. Phew</h4>
<div class="paragraph">
<p>Hopefully that has given you a taste of the process of building native images.
There is much more coming down the pipeline in Spring to optimize in all areas - smaller images, reduced memory usage, faster native image compilation.
We are also working with Graal team in all the pitfall areas shown above - things across the board should only get better.
If applying these techniques to your own application and having problems, see <a href="#troubleshooting">Troubleshooting</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="options">7. Options</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The behaviour of GraalVM native can be tweaked via options.
These are passed to <code>native-image</code> as command line parameters, in a <code>META-INF/native-image/native-image.properties</code> file with an <code>Arg</code> key or via the <code>&lt;buildArgs&gt;..&lt;/buildArgs&gt;</code> block when invoking via maven.</p>
</div>
<div class="sect2">
<h3 id="_graalvm_options">7.1. GraalVM options</h3>
<div class="sect3">
<h4 id="_options_enabled_by_default">7.1.1. Options enabled by default</h4>
<div class="paragraph">
<p>These options are enabled by default when using <code>spring-graal-native</code> since they are mandatory to make Spring application working when compiled as GraalVM native images.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--allow-incomplete-classpath</code> allows image building with an incomplete class path and reports type resolution errors at run time when they are accessed the first time, instead of during image building.</p>
</li>
<li>
<p><code>--report-unsupported-elements-at-runtime</code> reports usage of unsupported methods and fields at run time when they are accessed the first time, instead of as an error during image building.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_options_recommended_by_default">7.1.2. Options recommended by default</h4>
<div class="ulist">
<ul>
<li>
<p><code>--no-server</code> means do not use image-build server which can be sometimes unreliable.</p>
</li>
<li>
<p><code>--verbose</code> makes image building output more verbose.</p>
</li>
<li>
<p><code>--no-fallback</code> enforce native image only runtime and disable fallback on regular JVM</p>
</li>
<li>
<p><code>-H:+ReportExceptionStackTraces</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_other_options">7.1.3. Other options</h4>
<div class="ulist">
<ul>
<li>
<p><code>--initialize-at-build-time</code> without any class or package specified initialize classes by default at build time.
Currently (hopefully temporarily) required for Netty based application, but not recommended for other kind of application since it can trigger compatibility issues especially regarding to logging and static fields.
See <a href="https://github.com/spring-projects-experimental/spring-graal-native/issues/8">this issue</a> for more details.
It can be used with specific classes or package specified if needed.</p>
</li>
<li>
<p><code>-H:+PrintAnalysisCallTree</code> helps to find what classes/methods/fields are used and why, more details in GraalVM <a href="https://github.com/oracle/graal/blob/master/substratevm/REPORTS.md">reports documentation</a>.</p>
</li>
<li>
<p><code>-H:+TraceClassInitialization</code> provides useful information to debug class initialization issues.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_feature_options">7.2. Feature options</h3>
<div class="paragraph">
<p>The current options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-Dspring.graal.remove-unused-autoconfig=true</code> removes unused configurations, enabling faster compilation and smaller executables.</p>
</li>
<li>
<p><code>-Dspring.graal.mode=initialization-only</code> flips the feature into a lightweight mode that only supplies substitutions and initialization configuration. It will no longer set reflection, resource or proxy data - relying on the project to supply that. This is a good mode for the feature when using the GraalVM agent to compute the project configuration as discussed <a href="#agent">here</a>.</p>
</li>
<li>
<p><code>-Dspring.graal.verbose=true</code> outputs lots of information about the feature behaviour as it processes auto configuration and chooses which to include.</p>
</li>
<li>
<p><code>-Dspring.graal.skip-logback=true</code> skips Logback configuration.</p>
</li>
<li>
<p><code>-Dspring.graal.remove-yaml-support=true</code> removes Yaml support from Spring Boot, enabling faster compilation and smaller executables.</p>
</li>
<li>
<p><code>-Dspring.graal.dump-config=/tmp/dump.txt</code> dumps the configuration to the specified file.</p>
</li>
<li>
<p><code>-Dspring.graal.missing-selector-hints=warning</code> switches the feature from a hard error for missing hints to a warning. See the <a href="#troubleshooting">Troubleshooting</a> section for more details on this.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===Optional options</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--enable-all-security-services</code> required for HTTPS and crypto.</p>
</li>
<li>
<p><code>--static</code> builds a statically linked executable, useful to deploy on a <code>FROM scratch</code> Docker image.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="samples">8. Samples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are numerous samples in the <code>spring-graal-native-samples</code> subfolder of the root project.
These show the feature in use with different technologies.</p>
</div>
<div class="paragraph">
<p>The samples don&#8217;t all currently use maven.
Instead they are built for us to play around with a little more easily.
Each includes a <code>build.sh</code> script which (java) builds the app, then calls the <code>compile.sh</code> script to run the native-image process then a <code>verify.sh</code> script is used to check the built image works.</p>
</div>
<div class="paragraph">
<p>Our build process for the feature currently runs <code>./build.sh</code> in the root of the project and then <code>./build-samples.sh</code> to build all the samples and verify everything is working.
Building native-images takes quite a long time and eats RAM.</p>
</div>
<div class="paragraph">
<p>The samples show the wide variety of tech that is working fine: tomcat, netty, thymeleaf, jpa, etc, there is even a petclinic in there that brings multiple technologies together in one app.</p>
</div>
<div class="paragraph">
<p>If starting out attempting to build your first Spring Boot application, we recommend you follow one of the guides</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="troubleshooting">9. Troubleshooting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whilst trying to build native images various things can go wrong, either at image build time or at runtime when attempting to launch the built image.
Usually the problem is a lack of configuration - GraalVM native-image wasn&#8217;t told about the application intending to reflectively call something or load a resource.
But there can also be more serious problems, native-image crashing or the application using a third party library that includes code not compatible with native-image.</p>
</div>
<div class="paragraph">
<p>This page will explore some of the errors that can encountered and any fixes or workarounds possible.
The two main sections of this page are problems at image build time and problems at image runtime.</p>
</div>
<div class="paragraph">
<p>The Spring team is actively working with the Graal team on issues, those currently open can be seen <a href="https://github.com/oracle/graal/projects/2?card_filter_query=label%3Aspring">here</a>.
This page tracks spring labelled issues on the Graal issue tracker.</p>
</div>
<div class="sect2">
<h3 id="_native_image_is_failing">9.1. <code>native-image</code> is failing</h3>
<div class="sect3">
<h4 id="_out_of_memory_when_building_the_native_image">9.1.1. out of memory when building the native image</h4>
<div class="paragraph">
<p><code>native-image</code> consumes a lot of RAM.
We have most success on 32G RAM desktop machines.
16G is possible for smaller samples but 8G machines are likely to hit problems more often.</p>
</div>
</div>
<div class="sect3">
<h4 id="_weird_crash">9.1.2. Weird crash</h4>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Exception during JVMCI compiler initialization:
Exception in thread "main": java.lang.ExceptionInInitializerError
java.lang.ExceptionInInitializerError
	at com.oracle.svm.core.hub.ClassInitializationInfo.initialize(ClassInitializationInfo.java:290)
	at java.lang.Class.ensureInitialized(DynamicHub.java:496)
	at java.lang.System.getenv(System.java:897)
	at org.graalvm.libgraal.jni.JNIUtil.traceLevel(JNIUtil.java:268)
	at org.graalvm.libgraal.jni.JNIUtil.trace(JNIUtil.java:292)
	at org.graalvm.libgraal.jni.HotSpotToSVMScope.&lt;init&gt;(HotSpotToSVMScope.java:114)
	at org.graalvm.compiler.hotspot.management.libgraal.HotSpotGraalManagement.defineClassesInHotSpot(HotSpotGraalManagement.java:170)
	at org.graalvm.compiler.hotspot.management.libgraal.HotSpotGraalManagement.initialize(HotSpotGraalManagement.java:115)
	at org.graalvm.compiler.hotspot.HotSpotGraalRuntime.&lt;init&gt;(HotSpotGraalRuntime.java:178)
	at org.graalvm.compiler.hotspot.HotSpotGraalCompilerFactory.createCompiler(HotSpotGraalCompilerFactory.java:156)
	at org.graalvm.compiler.hotspot.HotSpotGraalCompilerFactory.createCompiler(HotSpotGraalCompilerFactory.java:134)
	at org.graalvm.compiler.hotspot.HotSpotGraalCompilerFactory.createCompiler(HotSpotGraalCompilerFactory.java:52)
	at jdk.vm.ci.hotspot.HotSpotJVMCIRuntime.getCompiler(HotSpotJVMCIRuntime.java:599)
	at jdk.vm.ci.hotspot.HotSpotJVMCIRuntime.compileMethod(HotSpotJVMCIRuntime.java:667)
	at com.oracle.svm.jni.JNIJavaCallWrappers.jniInvoke_VA_LIST_Nonvirtual:Ljdk_vm_ci_hotspot_HotSpotJVMCIRuntime_2_0002ecompileMethod_00028Ljdk_vm_ci_hotspot_HotSpotResolvedJavaMethod_2IJI_00029Ljdk_vm_ci_hotspot_HotSpotCompilationRequestResult_2(JNIJavaCallWrappers.java:0)
Caused by: java.lang.ArrayIndexOutOfBoundsException: Index 83 out of bounds for length 82
	at com.oracle.svm.jni.functions.JNIFunctions.SetObjectArrayElement(JNIFunctions.java:683)
	at java.lang.ProcessEnvironment.environ(ProcessEnvironment.java)
	at java.lang.ProcessEnvironment.&lt;clinit&gt;(ProcessEnvironment.java:70)
	at com.oracle.svm.core.hub.ClassInitializationInfo.invokeClassInitializer(ClassInitializationInfo.java:350)
	at com.oracle.svm.core.hub.ClassInitializationInfo.initialize(ClassInitializationInfo.java:270)
	... 14 more
Error: Image build request failed with exit status 255</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This has been seen with Graal 20.0 - current workaround is just to re-run, it is intermittent.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_built_image_will_not_run">9.2. the built image will not run</h3>
<div class="sect3">
<h4 id="_missing_resource_bundles">9.2.1. missing resource bundles</h4>
<div class="paragraph">
<p>In some cases when there is a problem the error message will try to tell you exactly what to do:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Caused by: java.util.MissingResourceException:
  Resource bundle not found javax.servlet.http.LocalStrings.
  Register the resource bundle using the option
    -H:IncludeResourceBundles=javax.servlet.http.LocalStrings.</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here it is clear we should add <code>-H:IncludeResourceBundles=javax.servlet.http.LocalStrings</code> to the <code>&lt;buildArgs&gt;</code> section in the <code>pom.xml</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_classnotfoundexception">9.2.2. ClassNotFoundException</h4>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Caused by: java.lang.ClassNotFoundException:
  org.apache.catalina.authenticator.jaspic.AuthConfigFactoryImpl
	at com.oracle.svm.core.hub.ClassForNameSupport.forName(ClassForNameSupport.java:60) ~[na:na]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This indicates the native-image build wasn&#8217;t told about the reflective need for a type and so did not include the data to satisfy a request to access it at runtime.</p>
</div>
<div class="paragraph">
<p>If using the agent, it can be a sign the agent is missing something (this particular message here was collected whilst debugging <a href="https://github.com/oracle/graal/issues/2198">issue 2198</a>).</p>
</div>
<div class="paragraph">
<p>Options to address it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>download a new version of GraalVM that includes a fixed agent.</p>
</li>
<li>
<p>raise a bug against the <code>spring-graal-native</code> project as a key aim of the feature is to make sure these things get registered.
If not 'obvious' that it should be registered then it may be necessary for a new or expanded hint to the added to the <code>spring-graal-native-configuration</code> project (see the extension guide for more into if you want to explore that)</p>
</li>
<li>
<p>manually add it.
The native-image run will pick up any configuration it finds.
In this case just create a <code>reflect-config.json</code> under a <code>META-INF/native-image</code> folder structure and ensure that is on the classpath.
This is sometimes easiest just by creating it in your project <code>src/main/resources</code> folder (so <code>src/main/resources/META-INF/native-image/reflect-config.json</code>).
An entry to satisfy the above error would look like this.
Note there are various access options to specify.
Here we are setting <code>allDeclaredConstructors</code> and <code>allDeclaredMethods</code>.
We might need <code>allDeclaredFields</code> if the code is intending to reflect on those too.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">[
{
 "name":"org.apache.catalina.authenticator.jaspic.AuthConfigFactoryImpl",
 "allDeclaredConstructors":true,
 "allDeclaredMethods":true
}
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Recompiling should pick up this extra config and the resultant image will include metadata to satisfy reflection of <code>AuthConfigFactoryImpl</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_where_has_my_logging_gone">9.3. Where has my logging gone?</h3>
<div class="paragraph">
<p>In standard operation <code>native-image</code> uses a server to optimize compilation speeds. Using the server has been known to produce native images that are missing logging. In this case add <code>--no-server</code> to the arguments being passed to <code>native-image</code>.</p>
</div>
<div class="sect3">
<h4 id="_no_access_hint_found_for_import_selector_xxx">9.3.1. No access hint found for import selector: XXX</h4>
<div class="paragraph">
<p>The feature chases down configuration references to other configurations (<code>@Import</code> usages).
However if using an import selector, that means code is deciding what the next imported configuration should be, which is harder to follow.
The feature doesn&#8217;t do that level of analysis (it could get very complicated).
This means although the feature can tell it has encountered a selector, it doesn&#8217;t know what types that selector needs reflective access to or what further configurations it is referencing.
Now, the feature could just continue - maybe it would work, maybe it would crash at runtime.
Typically the error you get can when there is a missing hint can be very cryptic. If the selector is doing a "if this type is around return this configuration to include" then it may simply be not finding some type (when it is really there, just not exposed in the image) and not including some critical configuration.
For this reason the feature fails early and fast indicating it doesn&#8217;t know what a particular selector is doing.
To fix it, take a look in the selector in question and craft a quick hint for it.
See <a href="https://github.com/spring-projects-experimental/spring-graal-native/commit/1251a274f81a3087b456d2178d2ae6405676d23b">this commit</a> that was fixing this kind of problem for spring security (<a href="https://github.com/spring-projects-experimental/spring-graal-native/issues/60">issue</a>).</p>
</div>
<div class="paragraph">
<p><em>IF</em> you are feeling brave, you can temporarily turn this hard error into a warning.
It is possible that in your case you don&#8217;t need what the selector is doing.
Specify the option <code>-Dspring.graal.missing-selector-hints=warning</code> - this will cause log messages about the problem but not a hard fail.
Beware :)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_diagnosing_issues_with_the_feature">9.4. Diagnosing issues with the feature</h3>
<div class="paragraph">
<p>Sometimes you want to use the feature but can&#8217;t - maybe you like that the feature does offer that more optimal mode of discarding unecessary configuration at image build time which the agent mode doesn&#8217;t.
When using the feature you either get an error about some missing piece of configuration, or worse you get no error and it doesn&#8217;t work (implying there is probably missing configuration but it isn&#8217;t critical for the app to start, it is just critical for it to actually work!).
If the error is clear then you can follow the guidlines in the <a href="#extension_guide">extension guide</a> and perhaps contribute it back.
But in the case where you have no idea, what do you do?</p>
</div>
<div class="paragraph">
<p>The first step to take here is try and run it with the agent.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mkdir -p native-image-config
mvn clean package
java -agentlib:native-image-agent=config-output-dir=native-image-config \
  -jar target/myapp-0.0.1-SNAPSHOT.jar</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>After hitting the app via whatever endpoints you want to be exercised and shutting it down, there will be config files in the output folder:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">ls -l native-image-config
-rw-r--r--  1 foo bar    135 26 Mar 11:25 jni-config.json
-rw-r--r--  1 foo bar    277 26 Mar 11:25 proxy-config.json
-rw-r--r--  1 foo bar  32132 26 Mar 11:25 reflect-config.json
-rw-r--r--  1 foo bar    461 26 Mar 11:25 resource-config.json</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now, we want to compare that native-image-config/reflect-config.json with the configuration being produced by the feature.
Luckily the feature supports a dump mode where it will put it out on disk for us to see.
Add this to the maven &lt;buildArgs&gt;&#8230;&#8203;&lt;/buildArgs&gt; section or as a parameter in the direct call to native-image.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">-DdumpConfig=/a/b/c/feature-reflect-config.json</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then after running the native image build again that file will exist.
It is now possible to diff the computed one with the agent one. The scripts folder in spring-graal-native contains a compare script:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">~/spring-graal-native/scripts/reflectCompare.sh feature-reflect-config.json native-image-config/reflect-config.json &gt; diff.txt</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This will produce a summary of the differences.
It understands the format a little better than just doing a 'diff':</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ tail diff.txt
...

Summary:
In first but not second: 395
In second but not first: 69
In both files but configured differently: 51
In both files and configured the same: 67</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We might search that for what entries are in the agent file that aren&#8217;t in the computed file for Spring:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">grep "^&gt; org.spring" diff.txt</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This will show data like this:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">&gt; org.springframework.context.ApplicationEventPublisherAware setFlags:[allPublicMethods]
&gt; org.springframework.context.ApplicationListener setFlags:[allPublicMethods]
&gt; org.springframework.context.EnvironmentAware setFlags:[allPublicMethods]
&gt; org.springframework.context.SmartLifecycle setFlags:[allPublicMethods]
&gt; org.springframework.core.annotation.AliasFor setFlags:[allDeclaredMethods]
&gt; org.springframework.core.annotation.SynthesizedAnnotation</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>These can be crafted into a config file for the project:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mkdir -p src/main/resources/META-INF/native-image</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now create src/main/resources/META-INF/native-image/reflect-config.json with content like this (just including the first one from the diff in this example):</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">[
{"name":"org.springframework.context.ApplicationEventPublisherAware","allPublicMethods":true}
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As we add the ones found in the diff we can rebuild the native-image each time and see which help.
Once computed, we can create a hint in the feature configuration project that captures this knowledge (see the <a href="#extension_guide">extension guide</a> for more info on that) or, if it is more related to this specific application than the infrastructure, we might leave that reflect-config.json in the project and commit it to our repository alongside the source for future use.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-04-07 09:18:06 -0500
</div>
</div>
</body>
</html>